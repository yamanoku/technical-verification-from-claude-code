# Simple scope SSR検証

## 概要

Simple scope (https://simple-stack.dev/scope) ライブラリのSSR環境でのハイドレーションエラー検証を実施します。

## 検証対象フレームワーク

- Nuxt
- SvelteKit  
- Astro

## 検証内容

各フレームワークの最新SSR環境でSimple scopeライブラリを使用した際に、ハイドレーションエラーが発生するかどうかを検証します。

## 結果

検証結果は各フレームワークのディレクトリ内に記録されます。

- `nuxt-test/` - Nuxtでの検証結果
- `sveltekit-test/` - SvelteKitでの検証結果
- `astro-test/` - Astroでの検証結果

## Simple scopeライブラリについて

Simple scopeは、クライアントサイドで一意のIDを生成するライブラリです。
SSR環境では、サーバーサイドとクライアントサイドで異なるIDが生成される可能性があり、
これがハイドレーションエラーの原因となる可能性があります。

### 予想される問題点

1. **ID生成のタイミング差**: サーバーサイドレンダリング時とクライアントサイドハイドレーション時で異なるIDが生成される
2. **初期化タイミング**: ライブラリの初期化がSSRとCSRで異なるタイミングで実行される
3. **ランダム値の同期**: サーバーとクライアント間でランダム値やタイムスタンプベースの値が同期しない

## 検証結果

### 総合結論

**Simple scopeライブラリは、すべての検証対象フレームワーク（Nuxt、SvelteKit、Astro）でハイドレーションエラーを引き起こします。**

これは、Simple scopeがクライアントサイド専用の一意ID生成ライブラリとして設計されているためです。

### フレームワーク別の問題詳細

#### 1. Nuxt
- **主要な問題**: Vue のhydrationエラーが明確に表示される
- **症状**: `[Vue warn]: Hydration node mismatch` エラー
- **影響**: 再レンダリングによるパフォーマンス低下
- **解決策**: `ClientOnly`コンポーネントまたは`onMounted`での遅延実行

#### 2. SvelteKit
- **主要な問題**: Server load関数とclient-side実行での値の不一致
- **症状**: Text content mismatch警告
- **影響**: `browser`環境変数を使用しても初期レンダリング時のミスマッチは発生
- **解決策**: `onMount`での初期化とbrowser環境チェック

#### 3. Astro
- **主要な問題**: サーバーコンポーネントとクライアントスクリプトでの値の差異
- **症状**: 視覚的に異なる値が表示される（エラーメッセージは控えめ）
- **影響**: アイランドアーキテクチャにより影響は局所的
- **解決策**: `client:load`ディレクティブまたはクライアント専用スクリプト

### 共通の根本原因

1. **実行環境の違い**
   - サーバー: Node.js環境
   - クライアント: ブラウザ環境

2. **実行タイミングの違い**
   - サーバー: ビルド時またはリクエスト時
   - クライアント: ハイドレーション時

3. **ランダム値生成の差異**
   - 異なる環境で異なるランダム値が生成される

### 推奨解決策

#### 1. クライアント専用実行（推奨）
```javascript
// 各フレームワーク共通パターン
onMount/useEffect/script(() => {
  const { scope } = await import('@simple-stack/scope');
  // クライアントサイドでのみ実行
});
```

#### 2. SSR対応ライブラリへの移行
- `nanoid`: SSR対応のID生成ライブラリ
- `uuid`: 標準的なUUID生成ライブラリ
- `crypto.randomUUID()`: ブラウザネイティブAPI（Polyfillあり）

#### 3. 条件付きレンダリング
```javascript
// サーバーサイドでは表示せず、クライアントサイドでのみ表示
{isClient && <ScopeComponent />}
```

### パフォーマンス影響

- **再レンダリング**: ハイドレーションエラーによる追加レンダリング
- **レイアウトシフト**: クライアントサイドでの値更新による画面のずれ
- **JavaScript負荷**: 動的インポートによる追加のバンドルサイズ

### セキュリティ考慮事項

Simple scopeをSSR環境で使用する際の注意点：
- サーバーサイドで生成されたIDがクライアントに露出する
- 予測可能なIDパターンがないか確認が必要

## 技術検証の結論

Simple scopeライブラリは、その設計思想上、SSR環境での使用には適していません。各フレームワークで提供される適切な回避策を使用するか、SSR対応の代替ライブラリの使用を強く推奨します。